@startuml Wallet: Share Token


actor User as user
participant "Wallet ğŸ‘±\n(app)" as wallet
participant "Notifier ğŸ“£\n(domain)" as notifier
participant "Broker ğŸ¤µ\n(domain)" as broker
participant "Consumer ğŸ’¼\n(host)" as consumer
participant "Identity ğŸ†”\n(vault)" as identity
participant "Graph ğŸ•¸\n(domain)" as graph

' --------------------
' QUERY
' --------------------

activate consumer

group Share token

    consumer --> broker: query@
    deactivate consumer

    activate broker
        broker -> graph: queryable@ {codes}
        broker -> graph: translate@ {codes}
        broker --> notifier: query@
    deactivate broker

    activate notifier
        notifier --> wallet
    deactivate notifier

    activate wallet
        user --> wallet: share
        wallet --> consumer: verify@ {tokens}
    deactivate wallet

    activate consumer
    consumer -> graph: trusts@ {issuers}

end group


group Request ID check

    consumer -> graph: trusts@ {identity}
    consumer --> broker: query@ 
    deactivate consumer

    activate broker
        broker --> identity: delegate@ {ID locator}
    deactivate broker

    activate identity
        identity -> graph: trusts@ 


end group

group Verify ID

        identity --> broker: prompt@
    deactivate identity

    activate broker
        broker --> notifier: prompt@
    deactivate broker

    activate notifier
        notifier --> wallet
    deactivate notifier

    ' Wallet ğŸ‘±
    activate wallet
        wallet -> identity: prompted@
        activate identity
            identity -> wallet: {prompt}
        deactivate identity

        user --> wallet: selfie
        wallet -> identity: iframe@

        activate identity
            identity -> wallet: {liveness html page}
        deactivate identity

        wallet --> identity: reply@
    deactivate wallet
    activate identity

end group


group Confirm ID 

        identity --> consumer: consume@ 
    deactivate identity

    ' CONSUMER
    activate consumer   
        consumer -> graph: trusts@ {identity}
        consumer -> identity: collect@
        activate identity
            identity -> consumer: {data}
        deactivate identity

end group

    deactivate consumer

@enduml 