@startuml Idempotency

box sender ğŸ‘¥ domain #FFFFFA
    participant "Script ğŸ“ƒ" as script
end box

box receiver ğŸ‘¥ domain #FFFFFA
    participant "Handler ğŸŒ" as handler
    participant "Dataset ğŸª£ Key: hook, sender" as table
    participant "OnInserted ğŸ””" as event
end box


activate script
    script -> script: .UUID >> hook
    script --x handler: SEND ğŸ“¬ {hook}
    
activate handler
    handler -> table: SAVE ğŸ’¾ {hook, sender}
activate table
    table -> handler: saved âœ…
deactivate handler
    table --> event: Event ğŸ”” {INSERTED}
deactivate table

    script -> script: retry 
    activate script
        script --> handler: SEND ğŸ“¬ {hook}
    deactivate script
deactivate script

activate handler
    handler -> table: SAVE ğŸ’¾ {hook, sender}


activate table
    table -> handler: ignore duplicate key if fields are equal âœ… 
deactivate handler
    table -x handler: raise error on duplicate key if fields differ âŒ 
deactivate table


@enduml