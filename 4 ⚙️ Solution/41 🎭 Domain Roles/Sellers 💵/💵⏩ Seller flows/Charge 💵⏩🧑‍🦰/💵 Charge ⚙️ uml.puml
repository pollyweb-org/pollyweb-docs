' https://quip.com/5rXfA36af1FM

@startuml
' ----------------------

participant "Seller ðŸ’µ" as seller
participant "Broker ðŸ¤µ" as broker
participant "Payer ðŸ’³" as payer
participant "Wallet ðŸ‘±" as wallet
participant "Collector ðŸ¦" as collector
participant "Notifier ðŸ“£" as notifier
actor User as user
participant "Graph ðŸ•¸" as graph



group Ask for the bill

activate seller
    seller --> collector: Register ðŸŒ
    seller --> broker: Charge ðŸŒ 
deactivate seller

activate broker
    broker --> payer: ðŸŒ Disclose @ Vault
deactivate broker

activate payer
    payer --> wallet: ONE ðŸ¤” "how to pay?"
deactivate payer

activate wallet
    wallet -> seller: ðŸš€ Download @ Host {bill}
    wallet --> payer: ðŸŒ Reply @ Host 
deactivate wallet

activate payer
    payer -> payer: transfer funds ðŸ’µ
    payer --> collector: ðŸŒ Consume @ Consumer
deactivate payer

activate collector
    collector -> payer: Collect @ Vault ðŸš€ {transfer proof}
    collector --> seller: ðŸŒ Consume @ Consumer
deactivate collector

activate seller
    seller -> collector: Collect @ Vault ðŸš€ {transfer proof}
deactivate seller

activate broker
    broker --> notifier: charge@
deactivate broker

    activate notifier
    notifier --> wallet
    deactivate notifier

      activate wallet
      wallet -> seller: download bill
      user --> wallet: review()

end group

group Pay for bill

  wallet --> seller: {OK} 
  deactivate wallet

' ----------------------
' CHARGE
' ----------------------
activate seller
seller --> broker: charge\n- collectors
deactivate seller
activate broker

loop for each collector

activate broker
broker -> graph: trustable \n- collector \n- payers 
activate graph
broker <- graph: {payer sets}
deactivate graph
deactivate broker

end loop

broker -> broker: merge(sets)
broker --> notifier: charge(payers)
deactivate
activate notifier
notifier --> wallet: charge(...)
deactivate notifier

end group

' ----------------------
@enduml 